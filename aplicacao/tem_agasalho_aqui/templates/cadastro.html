<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro - Agasalho Aqui</title>
    <link rel="icon" type="image/png" href="/static/images/HeartBoxlogoFAV.png">
    <link rel="shortcut icon" type="image/png" href="/static/images/HeartBoxlogoFAV.png">
    <link rel="stylesheet" href="/static/css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <div class="container header-container">
            <a href="/">
                <img src="/static/images/logotipo.png" alt="Logo Agasalho Aqui" class="logo">
            </a>
            <nav class="nav-menu">
                <a href="/">Home</a>
                <a href="/sobre">Sobre</a>
                <a href="/pontosdecoleta">Pontos de Coleta</a>
                <a href="/cadastro">Cadastro</a>
                <a href="/administracao">Administração</a>
            </nav>
        </div>
</header>


<main>
        <div class="container">
            <h1 class="page-title">CADASTRO</h1>
            
            <div class="form-container">
                <p class="form-description">Quer ser divulgado em nossa plataforma como ponto de coleta? Cadastre-se abaixo</p>
                <br>
                
                <form id="cadastro-form">

<div class="form-group">
    <label for="nome">Nome da Instituição*</label>
    <input type="text" id="nome" name="nome" class="form-control" required>
</div>

<div class="form-group">
    <label for="email">E-mail*</label>
    <input type="email" id="email" name="email" class="form-control" required placeholder="email@exemplo.com.br">
</div>

<div class="form-group">
    <label for="telefone">Telefone*</label>
    <input type="tel" id="telefone" name="telefone" class="form-control" required placeholder="11 91234-5678">
</div>

<!-- Novo campo CEP com botão de busca -->
<div class="form-row">
    <div class="form-group col-md-4">
        <label for="cep">CEP*</label>
        
        <div class="input-group">
            <input type="text" id="cep" name="cep" class="form-control" maxlength="9" required>
            <div class="input-group-append">
                <button type="button" class="nav-button" id="buscar-cep">Buscar</button>
            </div>
        </div>
                
    </div>
</div>

<!-- Campo de endereço existente, agora com preenchimento automático -->
<div class="form-group">
    <label for="endereco">Logradouro*</label>
    <input type="text" id="endereco" name="endereco" class="form-control" required>
</div>

<!-- Novos campos para complemento de endereço -->
<div class="form-row">
    <div class="form-group col-md-2">
        <label for="numero">Número*</label>
        <input type="text" id="numero" name="numero" class="form-control" required>
    </div>
    <div class="form-group col-md-10">
        <label for="bairro">Bairro*</label>
        <input type="text" id="bairro" name="bairro" class="form-control" required>
    </div>
</div>

<div class="form-row">
    <div class="form-group col-md-8">
        <label for="cidade">Cidade*</label>
        <input type="text" id="cidade" name="cidade" class="form-control" required>
    </div>
    <div class="form-group col-md-4">
        <label for="uf">UF*</label>
        <select id="uf" name="uf" class="form-control" required>
            <option value="">Selecione...</option>
            <option value="AC">Acre</option>
            <option value="AL">Alagoas</option>
            <option value="AP">Amapá</option>
            <option value="AM">Amazonas</option>
            <option value="BA">Bahia</option>
            <option value="CE">Ceará</option>
            <option value="DF">Distrito Federal</option>
            <option value="ES">Espírito Santo</option>
            <option value="GO">Goiás</option>
            <option value="MA">Maranhão</option>
            <option value="MT">Mato Grosso</option>
            <option value="MS">Mato Grosso do Sul</option>
            <option value="MG">Minas Gerais</option>
            <option value="PA">Pará</option>
            <option value="PB">Paraíba</option>
            <option value="PR">Paraná</option>
            <option value="PE">Pernambuco</option>
            <option value="PI">Piauí</option>
            <option value="RJ">Rio de Janeiro</option>
            <option value="RN">Rio Grande do Norte</option>
            <option value="RS">Rio Grande do Sul</option>
            <option value="RO">Rondônia</option>
            <option value="RR">Roraima</option>
            <option value="SC">Santa Catarina</option>
            <option value="SP">São Paulo</option>
            <option value="SE">Sergipe</option>
            <option value="TO">Tocantins</option>
        </select>

    <!-- Substituir a seção dos campos horário e site -->

</div>
</div>
<!-- Fechamento correto da div form-row anterior -->

<!-- Campo de horário em sua própria linha -->
<div class="form-group">
    <label for="horario">Horário de Funcionamento*</label>
    <input type="text" id="horario" name="horario" class="form-control" required placeholder="Ex: Segunda a Sexta, 9h às 18h">
</div>

<!-- Campo de site em sua própria linha -->
<div class="form-group">
    <label for="site">Site (opcional)</label>
    <input type="url" id="site" name="site" class="form-control" placeholder="https://univesp.br/">
</div>

<div id="message" class="alert" style="display: none;"></div>

<button type="submit" class="submit-button">ENVIAR SOLICITAÇÃO</button>
    
    </form>
</div>
    </main>

    <footer>
        <div class="container footer-container">
            <div class="footer-logo-contact">
                <img src="/static/images/HeartBoxlogo.png" alt="Logo Agasalho Aqui" class="footer-logo">
                <div class="contact-info">
                    <h3>Fale conosco</h3>
                    <p><a href="mailto:agasalhoaqui@gmail.com">agasalhoaqui@gmail.com</a></p>
                    <p>(11) 4002-0922</p>
                </div>
            </div>
            <div class="footer-links">
                <a href="/termos">Termos e Condições</a> | 
                <a href="/privacidade">Políticas de Privacidade</a>
            </div>
            <p class="copyright">© Tem Agasalho Aqui LTDA - Todos os direitos reservados</p>
        </div>
    </footer>

  <!--  <script src="/static/js/scripts.js"></script> -->
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Referências aos elementos do formulário
            const cadastroForm = document.getElementById('cadastro-form');
            const messageDiv = document.getElementById('message');
            const cepInput = document.getElementById('cep');
            const buscarCepBtn = document.getElementById('buscar-cep');
            
            // SOMENTE limpar formulário na carga inicial
            if (sessionStorage.getItem('formReloading')) {
                sessionStorage.removeItem('formReloading');
                cadastroForm.reset();
            }
            
            // Evento para marcar recarregamento
            window.addEventListener('beforeunload', function() {
                sessionStorage.setItem('formReloading', 'true');
            });
            
            // Máscara para o CEP
            cepInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, ''); // Remove não-números
                if (value.length > 8) value = value.substring(0, 8);
                if (value.length > 5) {
                    value = value.substring(0, 5) + '-' + value.substring(5);
                }
                e.target.value = value;
            });
            
            // Buscar CEP ao sair do campo
            cepInput.addEventListener('blur', function() {
                if (this.value.replace(/\D/g, '').length === 8) {
                    buscarCEP();
                }
            });
            
            // Buscar CEP ao clicar no botão
            buscarCepBtn.addEventListener('click', buscarCEP);
            
            // Função para buscar CEP
            function buscarCEP() {
                const cep = cepInput.value.replace(/\D/g, '');
                if (cep.length !== 8) {
                    alert('CEP inválido. Digite um CEP com 8 dígitos.');
                    return;
                }
                
                // Mostrar indicador de carregamento
                const loadingState = document.createElement('div');
                loadingState.className = 'loading-indicator';
                loadingState.textContent = 'Buscando endereço...';
                cepInput.parentNode.appendChild(loadingState);
                
                // Desabilitar campos durante a busca
                setFieldsDisabled(true);
                
                // Consultar API ViaCEP
                fetch(`https://viacep.com.br/ws/${cep}/json/`)
                    .then(response => {
                        if (!response.ok) throw new Error('Erro ao buscar CEP');
                        return response.json();
                    })
                    .then(data => {
                        // Remover indicador de carregamento
                        if (loadingState.parentNode) {
                            loadingState.parentNode.removeChild(loadingState);
                        }
                        
                        // Verificar se o CEP foi encontrado
                        if (data.erro) {
                            alert('CEP não encontrado. Verifique o número digitado.');
                            setFieldsDisabled(false);
                            return;
                        }
                        
                        // Preencher os campos com os dados retornados
                        document.getElementById('endereco').value = data.logradouro || '';
                        document.getElementById('bairro').value = data.bairro || '';
                        document.getElementById('cidade').value = data.localidade || '';
                        document.getElementById('uf').value = data.uf || '';
                        
                        // Focar no campo número se o endereço foi preenchido
                        if (data.logradouro) {
                            document.getElementById('numero').focus();
                        }
                        
                        // Reativar os campos
                        setFieldsDisabled(false);
                    })
                    .catch(error => {
                        console.error('Erro:', error);
                        alert('Erro ao buscar o CEP. Por favor, tente novamente ou preencha manualmente.');
                        setFieldsDisabled(false);
                        
                        // Remover indicador de carregamento
                        if (loadingState.parentNode) {
                            loadingState.parentNode.removeChild(loadingState);
                        }
                    });
            }
            
            function setFieldsDisabled(disabled) {
                document.getElementById('endereco').disabled = disabled;
                document.getElementById('bairro').disabled = disabled;
                document.getElementById('cidade').disabled = disabled;
                document.getElementById('uf').disabled = disabled;
            }
            
            // Manipulação do envio do formulário
            cadastroForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Verificar campos - adicionei console.log para debug
                const nome = document.getElementById('nome').value.trim();
                const email = document.getElementById('email').value.trim();
                const telefone = document.getElementById('telefone').value.trim();
                const endereco = document.getElementById('endereco').value.trim();
                const numero = document.getElementById('numero').value.trim();
                const bairro = document.getElementById('bairro').value.trim();
                const cidade = document.getElementById('cidade').value.trim();
                const uf = document.getElementById('uf').value;
                const horario = document.getElementById('horario').value.trim();
                
                console.log('Valores dos campos:');
                console.log('Nome:', nome);
                console.log('Email:', email);
                console.log('Telefone:', telefone);
                console.log('Endereço:', endereco);
                console.log('Número:', numero);
                console.log('Bairro:', bairro);
                console.log('Cidade:', cidade);
                console.log('UF:', uf);
                console.log('Horário:', horario);
                
                // Validação
                const camposFaltando = [];
                if (!nome) camposFaltando.push('Nome da Instituição');
                if (!email) camposFaltando.push('E-mail');
                if (!telefone) camposFaltando.push('Telefone');
                if (!endereco) camposFaltando.push('Logradouro');
                if (!numero) camposFaltando.push('Número');
                if (!bairro) camposFaltando.push('Bairro');
                if (!cidade) camposFaltando.push('Cidade');
                if (!uf) camposFaltando.push('UF');
                if (!horario) camposFaltando.push('Horário de Funcionamento');
                
                if (camposFaltando.length > 0) {
                    showMessage(`Por favor, preencha os campos obrigatórios: ${camposFaltando.join(', ')}`, 'error');
                    return;
                }
                
                // Desabilitar botão durante o envio
                const submitButton = document.querySelector('.submit-button');
                submitButton.disabled = true;
                submitButton.textContent = 'ENVIANDO...';
                
                try {
                    // Preparar dados do formulário
                    const formData = new FormData();
                    formData.append('nome', nome);
                    formData.append('email', email);
                    formData.append('telefone', telefone);
                    formData.append('endereco', endereco);
                    formData.append('numero', numero);
                    formData.append('bairro', bairro);
                    formData.append('cidade', cidade);
                    formData.append('uf', uf);
                    formData.append('cep', cepInput.value.trim());
                    formData.append('horario', horario);
                    formData.append('site', document.getElementById('site').value.trim());
                    
                    // Enviar ao servidor
                    const response = await fetch('/api/solicitar-cadastro', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.error || 'Erro ao enviar solicitação');
                    }
                    
                    // Mostrar mensagem de sucesso
                    showMessage('Solicitação enviada com sucesso! Em breve entraremos em contato.', 'success');
                    cadastroForm.reset();
                    
                } catch (error) {
                    console.error('Erro:', error);
                    showMessage(error.message || 'Erro ao processar solicitação. Por favor, tente novamente.', 'error');
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'ENVIAR SOLICITAÇÃO';
                }
            });
            
            // Função para exibir mensagens
            function showMessage(text, type) {
                messageDiv.textContent = text;
                messageDiv.style.display = 'block';
                messageDiv.className = 'alert ' + (type === 'error' ? 'alert-error' : 'alert-success');
                messageDiv.scrollIntoView({ behavior: 'smooth' });
            }
        });
        </script>


</body>
</html>
